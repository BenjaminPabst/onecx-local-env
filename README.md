# onecx-local-env
OneCx local docker compose environment setup

## Before

Make sure that .sh scripts in /imports directory and its subdirectories are executable and also import-onecx.sh in the root folder

- e.g. `-rwxr-xr-x import-onecx.sh`
- if they are not executable, use the command `chmod +x <file>`

## Docker compose

The docker compose in this repo currently contains:

- `postgresdb` generic postgresql db
- `pgadmin` UI admin for Postgres, login as capgemini@capgemini.com/mysecretpassword
- `traefik` reverse proxy
- `keycloak-app` Access and Identity Management Tool
- OneCX portal products with its MS
  - `onecx-shell`
  - `onecx-permission`
  - `onecx-theme`
  - `onecx-iam`
  - `onecx-product-store`
  - `onecx-tenant`
  - `onecx-user-profile`
  - `onecx-workspace`

To run all the services(dont do it unless you really have to, always start only those services you need):

- `docker-compose up -d`

## Hosts file

In order to expose multiple services on the same port, we use traefik reverse proxy. It will be available via your hosts 80 port, and will route traffik to containers based on hostnames.
Therefore, for each service you want to access, do add an entry to your hosts files Windows: `c:\Windows\System32\drivers\etc\hosts` and Linux / WSL: `/etc/hosts`(wsl hosts file will be autogenerated from windows file when you restart wsl, unless you disabled that behaviour). Sample file (hosts.sample) is in this repo.

```
127.0.0.1       local-proxy
127.0.0.1       keycloak-app
127.0.0.1       pgadmin
127.0.0.1       onecx-shell-bff
127.0.0.1       onecx-theme-svc
127.0.0.1       onecx-theme-bff
127.0.0.1       onecx-workspace-svc
127.0.0.1       onecx-workspace-bff
127.0.0.1       onecx-user-profile-bff
127.0.0.1       onecx-user-profile-svc
127.0.0.1       onecx-permission-svc
127.0.0.1       onecx-permission-bff
127.0.0.1       onecx-product-store-svc
127.0.0.1       onecx-product-store-bff
127.0.0.1       onecx-iam-kc-svc
127.0.0.1       onecx-iam-bff
127.0.0.1		onecx-tenant-svc
127.0.0.1		onecx-tenant-bff
```

## Initial Data

Postgres server is automatically created with the necessary databases.
If any database needs to be added please modify the file init-data/db/init-db.sql

Keycloak db is populated with the following configuration(located in init-data/keycloak/realm-onecx.json):

- **Realm** - onecx
- **Clients** - all necessary UI clients for MFE and backends are in the
- **User** - onecx
- **Password** - onecx
- **Roles assigned to the user** - [onecx-admin]

## Import Data

In order to import the data use the script `import-onecx.sh`. Before the script is executed all the core backend services of onecx have to be up and running.

Folder structure
* tenant - import for the tenants
* theme - import for the themes
* permissions - import for permissions
* workspace - import for workspaces
* assignments - import of the assignments from role to permission
* product-store - import for all of the product store objects:
  * products - import for products
  * microfrontends - import for microfrontend
  * microservices - import for microservices
  * slots - import for slots

## Running

When running with the command `docker-compose up -d` all standard services are started and the core portal cann be accessed via this url `http://local-proxy/onecx-shell/admin`

After all services of onecx are up and running start the script `./import-onecx.sh`.
This will import all necessary objects to the database.
There is a user created from scratch (onecx with password onecx)

If there are some issues to run onecx microservices or the users are missing, after deleting the volume or after clearing the database and starting everything from scratch, it should work.

## Adding new microfrontend (MFE)

In order to run the MFE all bff and all backend MS need to run also.

### Localy build docker image of the MFE

After a local dockerimage of the MFE is created can be added to the docker-compose and started as any other service.

### Localy started in dev mode `npm start`

In order to use traefik and localy started MFE you need to enhance the npm start script located in package.json with `--host 0.0.0.0 --disable-host-check`

If it runs on the standard port 4200 you dont need to do anything special as this is already configured for the local_mfe service under ./init-data/traefik/traefik-services.yml
Only update the traefik config in docker-compose.yaml

EXAMPLE for onecx-tenant-ui (its already part of the docker-compose in the part of onecx-tenant-bff)
```
	  - "traefik.http.routers.local_mfe.entrypoints=web"
      - "traefik.http.routers.local_mfe.rule=Host(`local-proxy`)&&PathPrefix(`/mfe/tenant/`)"
      - "traefik.http.routers.local_mfe.service=local_mfe@file"
```

In order to get this working also the MFE local proxy configuration needs to be updated 
```
const PROXY_CONFIG = {
  '/mfe/tenant': {
    target: 'http://localhost:4200/',
    secure: false,
    pathRewrite: {
      '^.*/mfe/tenant': '',
    },
    changeOrigin: true,
    logLevel: 'debug',
    bypass: bypassFn,
  }
```